var mp4Remux=function(){"use strict";var $=Object.defineProperty;var tt=(U,b,n)=>b in U?$(U,b,{enumerable:!0,configurable:!0,writable:!0,value:n}):U[b]=n;var z=(U,b,n)=>(tt(U,typeof b!="symbol"?b+"":b,n),n);const U=Object.freeze(Object.defineProperty({__proto__:null,get edts(){return K},get free(){return S},get ftyp(){return G},get mdat(){return J},get mdia(){return F},get mfhd(){return P},get mfra(){return N},get mfro(){return X},get moof(){return y},get moov(){return O},get mvex(){return C},get mvhd(){return q},get sidx(){return R},get tfdt(){return W},get tfhd(){return B},get tfra(){return Q},get tkhd(){return T},get traf(){return A},get trak(){return j},get trex(){return M},get trun(){return D},get udta(){return H}},Symbol.toStringTag,{value:"Module"}));class b{constructor(){z(this,"_stream",new Uint8Array);z(this,"dv",new DataView(new Uint8Array().buffer))}get stream(){return this._stream}set stream(t){this._stream=t,this.dv=new DataView(t.buffer)}writeUint(t,e,s=0){const r=this.dv;switch(t){case 1:r.setUint8(s,e);break;case 2:r.setUint16(s,e);break;case 3:r.setUint16(s,e>>8),r.setUint8(s+2,e&255);return;case 4:r.setUint32(s,e);break}}writeInt(t,e,s=0){const r=this.dv;switch(t){case 1:r.setInt8(s,e);break;case 2:r.setInt16(s,e);break;case 4:r.setInt32(s,e);break}}readInt(t=4,e=0){const s=this.dv;switch(t){case 1:return s.getInt8(e);case 2:return s.getInt16(e);case 4:return s.getInt32(e)}}readUint(t,e=0){const s=this.dv;switch(t){case 1:return s.getUint8(e);case 2:return s.getUint16(e);case 3:return s.getUint16(e)<<8+s.getUint8(e+2);case 4:return s.getUint32(e)}}readString(t,e=0){let s="";for(let r=0;r<t;r++)s+=String.fromCharCode(this.readUint(1,e+r));return s}}class n extends b{constructor(e){super();z(this,"boxs",[]);z(this,"boxPos",0);this.stream=e}set size(e){this.writeUint(4,e)}get size(){return this.readUint(4)}get type(){return this.readString(4,4)}get raw(){if(this.boxPos){let e=this.boxPos;const s=this.boxs.map(_=>{const w=_.raw;return e+=w.length,w});this.size=e;const r=this.stream.slice(0,this.boxPos),o=new Uint8Array(e);let x=0;for(const _ of[r,...s])o.set(_,x),x+=_.length;return o}return this.stream}parse(e){this.boxPos=e;let s=e;for(;s<=this.stream.length-8;){const r=this.readUint(4,s),o=this.readString(4,4+s);if(r<=this.stream.length){const x=this.stream.slice(s,s+r),_=U[o]||S;this.boxs.push(new _(x))}s+=r}}}class M extends n{get version(){return this.readUint(1,8)}get track_id(){return this.readUint(4,12)}set track_id(t){this.writeUint(4,t,12)}}class D extends n{get sample_count(){return this.readUint(4,12)}get data_offset(){return this.readInt(4,16)}set data_offset(t){this.writeInt(4,t,16)}}class W extends n{}class B extends n{get version(){return this.readUint(1,8)}get track_id(){return this.readUint(4,12)}set track_id(t){this.writeUint(4,t,12)}}class A extends n{constructor(t){super(t),this.parse(8)}get tfhd(){return this.boxs.find(t=>t instanceof B)}get trun(){return this.boxs.find(t=>t instanceof D)}}class P extends n{get sequence_number(){return this.readUint(4,12)}}class H extends n{}class F extends n{}class G extends n{}class S extends n{}class O extends n{constructor(t){super(t),this.parse(8)}get mvhd(){return this.boxs.find(t=>t instanceof q)}get mvex(){return this.boxs.find(t=>t instanceof C)}get trak(){return this.boxs.find(t=>t instanceof j)}}class y extends n{constructor(t){super(t),this.parse(8)}get mfhd(){return this.boxs.find(t=>t instanceof P)}get traf(){return this.boxs.find(t=>t instanceof A)}}class R extends n{get version(){return this.readUint(1,8)}get reference_ID(){return this.readUint(4,12)}get timescale(){return this.readUint(4,16)}get reserved(){let t=28;return this.version!==0&&(t=36),this.readUint(2,t)}get reference_count(){let t=28;return this.version!==0&&(t=36),t+=2,this.readUint(2,t)}get refList(){let t=32;this.version!==0&&(t=40);const e=this.reference_count,s=[];for(let r=0;r<e;r++){const o=t+r*12;let x=this.readUint(4,o);const _=x>>31&1,w=x&2147483647,d=this.readUint(4,o+4);x=this.readUint(4,o+8);const m=x>>31&1,v=x>>28&7,I=x&268435455;s.push({reference_type:_,referenced_size:w,subsegment_duration:d,starts_with_SAP:m,SAP_type:v,SAP_delta_time:I})}return s}}class J extends n{push(t){const e=new Uint8Array(this.stream.length+t.length);e.set(this.stream),e.set(t,this.stream.length),this.stream=e,this.size=e.length}}class q extends n{get version(){return this.readUint(1,8)}get next_track_ID(){return this.version===0?this.readUint(4,104):this.readUint(4,116)}set next_track_ID(t){this.version===0?this.writeUint(4,t,104):this.writeUint(4,t,116)}}class C extends n{constructor(t){super(t),this.parse(8)}get trex(){return this.boxs.find(t=>t instanceof M)}}class T extends n{get version(){return this.readUint(1,8)}get track_id(){return this.version===1?this.readUint(4,28):this.readUint(4,20)}set track_id(t){this.version===1?this.writeUint(4,t,28):this.writeUint(4,t,20)}}class j extends n{constructor(t){super(t),this.parse(8)}get tkhd(){return this.boxs.find(t=>t instanceof T)}}class K extends n{}class N extends n{constructor(t){super(t),this.parse(8)}}class Q extends n{get track_ID(){return this.readUint(4,12)}set track_ID(t){this.writeUint(4,t,12)}get length_size_of_sample_num(){return this.readUint(4,16)&3}get length_size_of_trun_num(){return this.readUint(4,16)>>2&3}get length_size_of_traf_num(){return this.readUint(4,16)>>4&3}get number_of_entry(){return this.readUint(4,20)}set number_of_entry(t){this.writeUint(4,t,20)}}class X extends n{get _size(){return this.readUint(4,12)}set _size(t){this.writeUint(4,t,12)}}class E extends b{constructor(){super(...arguments);z(this,"boxs",[]);z(this,"isEnd",!1)}get sidx(){return this.boxs.find(e=>e instanceof R)}get moov(){return this.boxs.find(e=>e instanceof O)}push(e){const s=new Uint8Array(this.stream.length+e.length);s.set(this.stream),s.set(e,this.stream.length),this.stream=s}slice(e){const s=this.stream.slice(0,e),r=new Uint8Array(this.stream.length-e);return r.set(this.stream.slice(e)),this.stream=r,s}parse(){if(this.stream.length<8)return;const e=this.readUint(4),s=this.readString(4,4);if(e<=this.stream.length){const r=this.slice(e),o=U[s]||S;this.boxs.push(new o(r)),this.parse()}}end(){this.isEnd=!0}}function Y(a,t){const e=a.getReader(),s=t.getReader(),r=new E,o=new E,{readable:x,writable:_}=new TransformStream,w=_.getWriter();let d=-1;function m(f){w.write(f)}async function v(){if(d===-1){const f=r.moov,g=o.moov;if(f&&g){const i=f.mvex,h=g.mvex;if(i&&h){const c=i.trex,l=h.trex;c.track_id=1,l.track_id=2,i.boxs=[],c&&i.boxs.push(c),l&&i.boxs.push(l)}const u=f.trak,k=g.trak;if(u&&k){u.tkhd.track_id=1,k.tkhd.track_id=2,f.boxs.push(k);for(const c of r.boxs)if(m(c.raw),c===f)break;d=1}}}if(!(!r.sidx||!o.sidx)&&d!==-1){const f=r.sidx.reference_count,g=o.sidx.reference_count;if(d<=f&&d<=g){const i=r.boxs.find(c=>c instanceof y&&(c==null?void 0:c.mfhd.sequence_number)===d),h=o.boxs.find(c=>c instanceof y&&(c==null?void 0:c.mfhd.sequence_number)===d),u=i&&r.boxs[r.boxs.indexOf(i)+1],k=h&&o.boxs[o.boxs.indexOf(h)+1];if(i&&u&&h&&k){const c=i.traf,l=h.traf;if(c.tfhd.track_id=1,l.tfhd.track_id=2,c!=null&&c.trun&&(l!=null&&l.trun)){const L=l.size,V=i.size,Z=u.size;c.trun.data_offset=V+L+8,l.trun.data_offset=V+L+Z,i.boxs.push(l),m(i.raw),u.push(k.raw.slice(8)),m(u.raw),r.boxs=r.boxs.filter(p=>p!==i),r.boxs=r.boxs.filter(p=>p!==u),o.boxs=o.boxs.filter(p=>p!==h),o.boxs=o.boxs.filter(p=>p!==k),d+=1,v()}}}else if(d>f&&d<=g){const i=o.boxs.find(u=>u instanceof y&&(u==null?void 0:u.mfhd.sequence_number)===d);i.traf.tfhd.track_id=2;const h=i&&o.boxs[o.boxs.indexOf(i)+1];i&&h&&(m(i.raw),m(h.raw),d+=1,v())}else if(d>g&&d<=f){const i=r.boxs.find(u=>u instanceof y&&(u==null?void 0:u.mfhd.sequence_number)===d);i.traf.tfhd.track_id=1;const h=i&&r.boxs[r.boxs.indexOf(i)+1];i&&h&&(m(i.raw),m(h.raw),d+=1,v())}else d>f&&d>g&&(d=-2,w.close())}}async function I(f,g){for(;;){const{done:i,value:h}=await f.read();if(h&&(g.push(h),g.parse(),v()),i){g.end(),v();break}}}return I(e,r),I(s,o),x}return Y}();
//# sourceMappingURL=mp4-remux.iife.js.map
