var mp4Remux=function(){"use strict";var Q=Object.defineProperty;var X=(v,r,w)=>r in v?Q(v,r,{enumerable:!0,configurable:!0,writable:!0,value:w}):v[r]=w;var m=(v,r,w)=>(X(v,typeof r!="symbol"?r+"":r,w),w);const v=Object.freeze(Object.defineProperty({__proto__:null,get edts(){return J},get free(){return D},get ftyp(){return E},get mdat(){return H},get mdia(){return j},get mfhd(){return z},get moof(){return k},get moov(){return L},get mvex(){return B},get mvhd(){return F},get sidx(){return W},get tfdt(){return O},get tfhd(){return q},get tkhd(){return G},get traf(){return A},get trak(){return C},get trex(){return w},get trun(){return P},get udta(){return T}},Symbol.toStringTag,{value:"Module"}));class r{constructor(t){m(this,"stream",new Uint8Array);m(this,"dv",new DataView(new Uint8Array().buffer));m(this,"boxs",[]);m(this,"boxPos",0);this.stream=t,this.dv=new DataView(t.buffer)}set size(t){this.writeUint(4,t)}get size(){return this.readUint(4)}get type(){return this.readString(4,4)}get raw(){if(this.boxPos){let t=this.boxPos;const e=this.boxs.map(u=>{const _=u.raw;return t+=_.length,_});this.size=t;const s=this.stream.slice(0,this.boxPos),n=new Uint8Array(t);let i=0;for(const u of[s,...e])n.set(u,i),i+=u.length;return n}return this.stream}writeUint(t,e,s=0){const n=this.dv;switch(t){case 1:n.setUint8(s,e);break;case 2:n.setUint16(s,e);break;case 4:n.setUint32(s,e);break}}writeInt(t,e,s=0){const n=this.dv;switch(t){case 1:n.setInt8(s,e);break;case 2:n.setInt16(s,e);break;case 4:n.setInt32(s,e);break}}readInt(t=4,e=0){const s=this.dv;switch(t){case 1:return s.getInt8(e);case 2:return s.getInt16(e);case 4:return s.getInt32(e)}}readUint(t,e=0){const s=this.dv;switch(t){case 1:return s.getUint8(e);case 2:return s.getUint16(e);case 4:return s.getUint32(e)}}readString(t,e=0){let s="";for(let n=0;n<t;n++)s+=String.fromCharCode(this.readUint(1,e+n));return s}parse(t){this.boxPos=t;let e=t;for(;e<=this.stream.length-8;){const s=this.readUint(4,e),n=this.readString(4,4+e);if(s<=this.stream.length){const i=this.stream.slice(e,e+s),u=v[n]||D;this.boxs.push(new u(i))}e+=s}}}class w extends r{}class P extends r{get sample_count(){return this.readUint(4,12)}get data_offset(){return this.readInt(4,16)}set data_offset(t){this.writeInt(4,t,16)}}class O extends r{}class q extends r{}class A extends r{constructor(t){super(t),this.parse(8)}get trun(){return this.boxs.find(t=>t instanceof P)}}class z extends r{get sequence_number(){return this.readUint(4,12)}}class T extends r{}class j extends r{}class E extends r{}class D extends r{}class L extends r{constructor(t){super(t),this.parse(8)}}class k extends r{constructor(t){super(t),this.parse(8)}}class W extends r{get version(){return this.readUint(1,8)}get reference_ID(){return this.readUint(4,12)}get timescale(){return this.readUint(4,16)}get reserved(){let t=28;return this.version!==0&&(t=36),this.readUint(2,t)}get reference_count(){let t=28;return this.version!==0&&(t=36),t+=2,this.readUint(2,t)}get refList(){let t=32;this.version!==0&&(t=40);const e=this.reference_count,s=[];for(let n=0;n<e;n++){const i=t+n*12;let u=this.readUint(4,i);const _=u>>31&1,I=u&2147483647,c=this.readUint(4,i+4);u=this.readUint(4,i+8);const U=u>>31&1,y=u>>28&7,M=u&268435455;s.push({reference_type:_,referenced_size:I,subsegment_duration:c,starts_with_SAP:U,SAP_type:y,SAP_delta_time:M})}return s}}class H extends r{push(t){const e=new Uint8Array(this.stream.length+t.length);e.set(this.stream),e.set(t,this.stream.length),this.stream=e,this.dv=new DataView(this.stream.buffer),this.size=e.length}}class F extends r{}class B extends r{constructor(t){super(t),this.parse(8)}}class C extends r{}class G extends r{}class J extends r{}class R{constructor(){m(this,"stream",new Uint8Array);m(this,"dv",new DataView(new Uint8Array().buffer));m(this,"boxs",[]);m(this,"isEnd",!1)}get sidx(){return this.boxs.find(t=>t.type==="sidx")}get moov(){return this.boxs.find(t=>t.type==="moov")}push(t){const e=new Uint8Array(this.stream.length+t.length);e.set(this.stream),e.set(t,this.stream.length),this.stream=e,this.dv=new DataView(this.stream.buffer)}slice(t){const e=this.stream.slice(0,t),s=new Uint8Array(this.stream.length-t);return s.set(this.stream.slice(t)),this.stream=s,this.dv=new DataView(this.stream.buffer),e}readUint(t,e=0){const s=this.dv;switch(t){case 1:return s.getUint8(e);case 2:return s.getUint16(e);case 4:return s.getUint32(e)}}readString(t,e=0){let s="";for(let n=0;n<t;n++)s+=String.fromCharCode(this.readUint(1,e+n));return s}parse(){if(this.stream.length<8)return;const t=this.readUint(4),e=this.readString(4,4);if(t<=this.stream.length){const s=this.slice(t),n=v[e]||D;this.boxs.push(new n(s)),this.parse()}}end(){this.isEnd=!0}}function K(o,t){const e=o.getReader(),s=t.getReader(),n=new R,i=new R,{readable:u,writable:_}=new TransformStream,I=_.getWriter();let c=-1;function U(x){I.write(x)}async function y(){if(c===-1){const x=n.moov,b=i.moov;if(x&&b){const a=b.boxs.find(f=>f instanceof C),d=x.boxs.find(f=>f instanceof B),l=b.boxs.find(f=>f instanceof B);if(d&&l){const f=d.boxs.find(g=>g instanceof w),h=l.boxs.find(g=>g instanceof w);d.boxs=[],f&&d.boxs.push(f),h&&d.boxs.push(h)}if(a){x.boxs.push(a);for(const f of n.boxs)if(U(f.raw),f===x)break;c=1}}}if(!(!n.sidx||!i.sidx)&&c!==-1){const x=n.sidx.reference_count,b=i.sidx.reference_count;if(c<=x&&c<=b){const a=n.boxs.find(h=>h instanceof k&&h.boxs[0]instanceof z&&h.boxs[0].sequence_number===c),d=i.boxs.find(h=>h instanceof k&&h.boxs[0]instanceof z&&h.boxs[0].sequence_number===c),l=a&&n.boxs[n.boxs.indexOf(a)+1],f=d&&i.boxs[i.boxs.indexOf(d)+1];if(a&&l&&d&&f){const h=a.boxs.find(S=>S instanceof A),g=d.boxs.find(S=>S instanceof A);if(h!=null&&h.trun&&(g!=null&&g.trun)){const S=g.size,V=a.size,N=l.size;h.trun.data_offset=V+S+8,g.trun.data_offset=V+S+N,a.boxs.push(g),U(a.raw),l.push(f.raw.slice(8)),U(l.raw),n.boxs=n.boxs.filter(p=>p!==a),n.boxs=n.boxs.filter(p=>p!==l),i.boxs=i.boxs.filter(p=>p!==d),i.boxs=i.boxs.filter(p=>p!==f),c+=1,y()}}}else if(c>x&&c<=b){const a=i.boxs.find(l=>l instanceof k&&l.boxs[0]instanceof z&&l.boxs[0].sequence_number===c),d=a&&i.boxs[i.boxs.indexOf(a)+1];a&&d&&(U(a.raw),U(d.raw),c+=1,y())}else c>x&&c>b&&(c=-2,I.close())}}async function M(x,b){for(;;){const{done:a,value:d}=await x.read();if(d&&(b.push(d),b.parse(),y()),a){b.end(),y();break}}}return M(e,n),M(s,i),u}return K}();
//# sourceMappingURL=mp4-remux.iife.js.map
