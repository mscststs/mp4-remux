{"version":3,"file":"mp4-remux.umd.cjs","sources":["../src/basic.class.ts","../src/boxes.class/Mp4Box.class.ts","../src/boxes.class/trex.ts","../src/boxes.class/trun.ts","../src/boxes.class/tfdt.ts","../src/boxes.class/tfhd.ts","../src/boxes.class/traf.ts","../src/boxes.class/mfhd.ts","../src/boxes.class/udta.ts","../src/boxes.class/mdia.ts","../src/boxes.class/ftyp.ts","../src/boxes.class/free.ts","../src/boxes.class/moov.ts","../src/boxes.class/moof.ts","../src/boxes.class/sidx.ts","../src/boxes.class/mdat.ts","../src/boxes.class/mvhd.ts","../src/boxes.class/mvex.ts","../src/boxes.class/tkhd.ts","../src/boxes.class/trak.ts","../src/boxes.class/edts.ts","../src/boxes.class/mfra.ts","../src/boxes.class/tfra.ts","../src/boxes.class/mfro.ts","../src/Mp4Stream.class.ts","../src/index.ts"],"sourcesContent":["export default class StreamBasic {\n  _stream: Uint8Array = new Uint8Array();\n  dv: DataView = new DataView(new Uint8Array().buffer);\n\n  get stream(){\n    return this._stream;\n  }\n  set stream(val){\n    this._stream = val;\n    this.dv = new DataView(val.buffer);\n  }\n  writeUint(size: 1 | 2 | 3 | 4, val: number, pos = 0) {\n    const view = this.dv;\n    switch (size) {\n      case 1:\n        view.setUint8(pos, val);\n        break;\n      case 2:\n        view.setUint16(pos, val);\n        break;\n      case 3:\n        view.setUint16(pos, val >> 8);\n        view.setUint8(pos+2, val & 0xff);\n        return;\n      case 4:\n        view.setUint32(pos, val);\n        break;\n    }\n  }\n  writeInt(size: 1 | 2 | 4, val: number, pos = 0) {\n    const view = this.dv;\n    switch (size) {\n      case 1:\n        view.setInt8(pos, val);\n        break;\n      case 2:\n        view.setInt16(pos, val);\n        break;\n      case 4:\n        view.setInt32(pos, val);\n        break;\n    }\n  }\n\n  readInt(size: 1 | 2 | 4 = 4, pos = 0) {\n    const view = this.dv;\n    switch (size) {\n      case 1:\n        return view.getInt8(pos);\n      case 2:\n        return view.getInt16(pos);\n      case 4:\n        return view.getInt32(pos);\n    }\n  }\n\n  // use dataView to Get Unsigned Int\n  readUint(size: 1 | 2 | 3 | 4, pos = 0) {\n    const view = this.dv;\n    switch (size) {\n      case 1:\n        return view.getUint8(pos);\n      case 2:\n        return view.getUint16(pos);\n      case 3:\n        return view.getUint16(pos) << 8 + view.getUint8(pos+2)\n      case 4:\n        return view.getUint32(pos);\n    }\n  }\n  /**\n   * Read string by char code from Uint8Array\n   * @param size\n   */\n  readString(size: 4, pos = 0) {\n    let s = \"\";\n    for (let i = 0; i < size; i++) {\n      s += String.fromCharCode(this.readUint(1, pos + i));\n    }\n    return s;\n  }\n\n}","import { Box } from \"./types\";\nimport * as Boxes from \".\";\nimport StreamBasic from \"../basic.class\";\n\nexport class Mp4Box extends StreamBasic {\n  boxs: Box[] = [];\n  boxPos = 0; // 记录元数据和盒子数据的偏差\n\n  constructor(buf: Uint8Array) {\n    super();\n    this.stream = buf;\n  }\n\n  set size(value: number) {\n    this.writeUint(4, value);\n  }\n  get size() {\n    return this.readUint(4);\n  }\n  get type() {\n    return this.readString(4, 4);\n  }\n\n  /**\n   * 获取当前 box 的 binary\n   */\n  get raw() {\n    if (this.boxPos) {\n      let size = this.boxPos;\n      const bufs = this.boxs.map((item) => {\n        const boxRaw = item.raw;\n        size += boxRaw.length;\n        return boxRaw;\n      });\n      this.size = size;\n      const base = this.stream.slice(0, this.boxPos);\n\n      // 将 Uint8Array[] 合并成一个\n      const nbuf = new Uint8Array(size);\n      let pos = 0;\n      for (const item of [base, ...bufs]) {\n        nbuf.set(item, pos);\n        pos += item.length;\n      }\n      return nbuf;\n    }\n\n    return this.stream;\n  }\n  \n\n  parse(boxPos: number) {\n    this.boxPos = boxPos;\n    let pos = boxPos;\n    while (pos <= this.stream.length - 8) {\n      const size = this.readUint(4, pos);\n      const type = this.readString(4, 4 + pos);\n      if (size <= this.stream.length) {\n        const tBuf = this.stream.slice(pos, pos + size);\n\n        const BoxClass = Boxes[type as keyof typeof Boxes] || Boxes.free;\n        this.boxs.push(new BoxClass(tBuf));\n      }\n      pos += size;\n    }\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class trex extends Mp4Box {\n\n  get version() {\n    return this.readUint(1, 8);\n  }\n  get track_id():number{\n    return this.readUint(4,12);\n  }\n  set track_id(value){\n    this.writeUint(4,value,12);\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class trun extends Mp4Box {\n  get sample_count() {\n    return this.readUint(4, 12);\n  }\n  get data_offset() {\n    return this.readInt(4, 16);\n  }\n  set data_offset(val) {\n    this.writeInt(4, val, 16);\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class tfdt extends Mp4Box {}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class tfhd extends Mp4Box {\n  get version() {\n    return this.readUint(1, 8);\n  }\n  get track_id():number{\n    return this.readUint(4,12);\n  }\n  set track_id(value){\n    this.writeUint(4,value,12);\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\nimport { trun, tfhd } from \".\";\n\nexport class traf extends Mp4Box {\n  constructor(buf: Uint8Array) {\n    super(buf);\n    this.parse(8);\n  }\n  get tfhd() {\n    return this.boxs.find((box) => box instanceof tfhd) as tfhd;\n  }\n  get trun() {\n    return this.boxs.find((box) => box instanceof trun) as trun;\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class mfhd extends Mp4Box {\n  get sequence_number() {\n    return this.readUint(4, 12);\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class udta extends Mp4Box {}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class mdia extends Mp4Box {}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class ftyp extends Mp4Box {}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class free extends Mp4Box {}\n","import { Mp4Box } from \"./Mp4Box.class\";\nimport { mvhd, mvex, trak } from \".\";\n\nexport class moov extends Mp4Box {\n  constructor(buf: Uint8Array) {\n    super(buf);\n    this.parse(8);\n  }\n\n  get mvhd() {\n    return this.boxs.find((box) => box instanceof mvhd) as mvhd;\n  }\n  get mvex(){\n    return this.boxs.find((box) => box instanceof mvex) as mvex;\n  }\n  get trak(){\n    return this.boxs.find((box) => box instanceof trak) as trak;\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\nimport { mfhd, traf } from \"./\";\n\nexport class moof extends Mp4Box {\n  constructor(buf: Uint8Array) {\n    super(buf);\n    this.parse(8);\n  }\n  get mfhd(){\n    return this.boxs.find((box) => box instanceof mfhd) as mfhd\n  }\n  get traf(){\n    return this.boxs.find((box) => box instanceof traf) as traf\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class sidx extends Mp4Box {\n  get version() {\n    return this.readUint(1, 8);\n  }\n  get reference_ID() {\n    return this.readUint(4, 12);\n  }\n  get timescale() {\n    return this.readUint(4, 16);\n  }\n  get reserved() {\n    let offset = 8 + 20;\n    if (this.version !== 0) {\n      offset = 16 + 20;\n    }\n    return this.readUint(2, offset);\n  }\n  get reference_count() {\n    let offset = 8 + 20;\n    if (this.version !== 0) {\n      offset = 16 + 20;\n    }\n    offset += 2;\n    return this.readUint(2, offset);\n  }\n  get refList() {\n    let offset = 8 + 24;\n    if (this.version !== 0) {\n      offset = 16 + 24;\n    }\n    const refrenceCount = this.reference_count;\n    const resList = [];\n    for (let i = 0; i < refrenceCount; i++) {\n      const pos = offset + i * 12; // Position\n      let tmp_32 = this.readUint(4, pos);\n      const reference_type = (tmp_32 >> 31) & 0x1;\n      const referenced_size = tmp_32 & 0x7fffffff;\n      const subsegment_duration = this.readUint(4, pos + 4);\n      tmp_32 = this.readUint(4, pos + 8);\n      const starts_with_SAP = (tmp_32 >> 31) & 0x1;\n      const SAP_type = (tmp_32 >> 28) & 0x7;\n      const SAP_delta_time = tmp_32 & 0xfffffff;\n      resList.push({\n        reference_type,\n        referenced_size,\n        subsegment_duration,\n        starts_with_SAP,\n        SAP_type,\n        SAP_delta_time,\n      });\n    }\n    return resList;\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class mdat extends Mp4Box {\n  push(value: Uint8Array) {\n    // 向 stream 追加数据\n\n    const newBuf = new Uint8Array(this.stream.length + value.length);\n    newBuf.set(this.stream);\n    newBuf.set(value, this.stream.length);\n    this.stream = newBuf;\n    this.size = newBuf.length;\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class mvhd extends Mp4Box {\n\n  get version() {\n    return this.readUint(1, 8);\n  }\n\n  get next_track_ID(){\n    if(this.version === 0){\n      return this.readUint(4,104);\n    }else{\n      return this.readUint(4,116);\n    }\n  }\n  set next_track_ID(value){\n    if(this.version === 0){\n      this.writeUint(4,value,104);\n    }else{\n      this.writeUint(4,value,116);\n    }\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\nimport { trex } from \"./\";\n\nexport class mvex extends Mp4Box {\n  constructor(buf: Uint8Array) {\n    super(buf);\n    this.parse(8);\n\n\n  }\n  get trex(){\n    return this.boxs.find((box) => box instanceof trex) as trex;\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class tkhd extends Mp4Box {\n  get version() {\n    return this.readUint(1, 8);\n  }\n\n  get track_id():number{\n    if(this.version === 1){\n      return this.readUint(4, 28);\n    }else{\n      return this.readUint(4,20);\n    }\n  }\n  set track_id(value){\n    if(this.version === 1){\n      this.writeUint(4,value,28);\n    }else{\n      this.writeUint(4,value,20);\n    }\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\nimport { tkhd } from \"./tkhd\";\n\nexport class trak extends Mp4Box {\n  constructor(buf: Uint8Array) {\n    super(buf);\n    this.parse(8);\n  }\n  get tkhd(): tkhd {\n    return this.boxs.find((box) => box instanceof tkhd) as tkhd;\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class edts extends Mp4Box {}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class mfra extends Mp4Box {\n  constructor(buf: Uint8Array) {\n    super(buf);\n    this.parse(8);\n  }\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class tfra extends Mp4Box {\n  get track_ID(){\n    return this.readUint(4, 12);\n  }\n  set track_ID(value){\n    this.writeUint(4, value, 12);\n  }\n\n  get length_size_of_sample_num(){\n    const tmp = this.readUint(4, 16);\n    return tmp & 0x3;\n  }\n\n  get length_size_of_trun_num(){\n    const tmp = this.readUint(4, 16);\n    return (tmp >> 2) & 0x3;\n  }\n\n  get length_size_of_traf_num(){\n    const tmp = this.readUint(4, 16);\n    return (tmp >> 4) & 0x3;\n  }\n\n  get number_of_entry(){\n    return this.readUint(4, 20);\n  }\n  set number_of_entry(value){\n    this.writeUint(4, value, 20);\n  }\n\n\n}\n","import { Mp4Box } from \"./Mp4Box.class\";\n\nexport class mfro extends Mp4Box {\n  get _size(){\n    return this.readUint(4,12);\n  }\n  set _size(value){\n    this.writeUint(4,value,12);\n  }\n}\n","import * as Boxes from \"./boxes.class\";\nimport { Box } from \"./boxes.class/types\";\nimport StreamBasic from \"./basic.class\";\n\nexport class Mp4Stream  extends StreamBasic{\n  boxs: Box[] = [];\n  isEnd = false;\n\n  get sidx() {\n    return this.boxs.find((box) => box instanceof Boxes.sidx) as Boxes.sidx;\n  }\n  get moov() {\n    return this.boxs.find((box) => box instanceof Boxes.moov) as Boxes.moov;\n  }\n\n  push(value: Uint8Array) {\n    const newBuf = new Uint8Array(this.stream.length + value.length);\n    newBuf.set(this.stream);\n    newBuf.set(value, this.stream.length);\n    this.stream = newBuf;\n  }\n\n  /**\n   * 将stream 截断，把pos前的数据返回，然后更新dataView\n   * @param pos\n   */\n  slice(pos: number) {\n    const sliceBuf = this.stream.slice(0, pos);\n    const newBuf = new Uint8Array(this.stream.length - pos);\n    newBuf.set(this.stream.slice(pos));\n    this.stream = newBuf;\n    return sliceBuf;\n  }\n  parse() {\n    // 检查this.stream 的长度是否足够 2*4*8\n    if (this.stream.length < 8) {\n      return; // Not Enough\n    }\n\n    const size = this.readUint(4);\n    const type = this.readString(4, 4);\n\n    if (size <= this.stream.length) {\n      const tBuf = this.slice(size);\n\n      const BoxClass = Boxes[type as keyof typeof Boxes] || Boxes.free;\n      this.boxs.push(new BoxClass(tBuf));\n\n      this.parse(); // 继续向后解析\n    }\n  }\n\n  end() {\n    this.isEnd = true;\n  }\n}\n","import { Mp4Stream } from \"./Mp4Stream.class\";\nimport * as Boxes from \"./boxes.class\";\n\nexport default function remux(vs: ReadableStream, as: ReadableStream) {\n  //  读取两个stream的数据\n  const videoReader = vs.getReader();\n  const audioReader = as.getReader();\n\n  const videoStream = new Mp4Stream();\n  const audioStream = new Mp4Stream();\n\n  const { readable, writable } = new TransformStream();\n  const writer = writable.getWriter();\n\n  let status = -1;\n\n  function callWrite(buf: Uint8Array) {\n    writer.write(buf);\n  }\n\n  async function checkStream() {\n    if (status === -1) {\n      // 合并 moov 中的 track 信息\n      const videoMoov = videoStream.moov;\n      const audioMoov = audioStream.moov;\n      if (videoMoov && audioMoov) {\n\n        const videoMvex = videoMoov.mvex;\n        const audioMvex = audioMoov.mvex;\n        if (videoMvex && audioMvex) {\n          const videoTrex = videoMvex.trex;\n          const audioTrex = audioMvex.trex;\n\n          videoTrex.track_id = 1;\n          audioTrex.track_id = 2;\n\n          // console.log(videoMvex, audioMvex);\n          videoMvex.boxs = [];\n          videoTrex && videoMvex.boxs.push(videoTrex);\n          audioTrex && videoMvex.boxs.push(audioTrex);\n        }\n\n        const videoTrak = videoMoov.trak;\n        const audioTrak = audioMoov.trak;\n        if (videoTrak && audioTrak) {\n          videoTrak.tkhd.track_id = 1;\n          audioTrak.tkhd.track_id = 2;\n\n          videoMoov.boxs.push(audioTrak);\n          for (const item of videoStream.boxs) {\n            callWrite(item.raw);\n            if (item === videoMoov) {\n              break;\n            }\n          }\n          status = 1;\n        }\n      }\n    }\n\n    // 需要先有 sidx\n    if (!videoStream.sidx || !audioStream.sidx) {\n      return;\n    }\n\n    if (status !== -1) {\n      const videoMaxIndex = videoStream.sidx.reference_count;\n      const audioMaxIndex = audioStream.sidx.reference_count;\n      if (status <= videoMaxIndex && status <= audioMaxIndex) {\n        // 合并\n\n        // Step1 获取需要的分片数据\n        const videoMoof = videoStream.boxs.find((item) => {\n          return (\n            item instanceof Boxes.moof && item?.mfhd.sequence_number === status\n          );\n        }) as Boxes.moof;\n        const audioMoof = audioStream.boxs.find((item) => {\n          return (\n            item instanceof Boxes.moof && item?.mfhd.sequence_number === status\n          );\n        }) as Boxes.moof;\n        const videoData = videoMoof && (videoStream.boxs[videoStream.boxs.indexOf(videoMoof) + 1] as Boxes.mdat);\n        const audioData = audioMoof && (audioStream.boxs[audioStream.boxs.indexOf(audioMoof) + 1] as Boxes.mdat);\n\n        if (videoMoof && videoData && audioMoof && audioData) {\n          // 处理合并流程\n          const videoTraf = videoMoof.traf;\n          const audioTraf = audioMoof.traf;\n\n          videoTraf.tfhd.track_id = 1;\n          audioTraf.tfhd.track_id = 2;\n          if (videoTraf?.trun && audioTraf?.trun) {\n            const audioTrafSize = audioTraf.size;\n            const videoMoofSize = videoMoof.size;\n            const videoDataSize = videoData.size;\n            videoTraf.trun.data_offset = videoMoofSize + audioTrafSize + 8;\n            audioTraf.trun.data_offset = videoMoofSize + audioTrafSize + videoDataSize;\n\n            videoMoof.boxs.push(audioTraf);\n\n            callWrite(videoMoof.raw);\n\n            // 处理 mdat 合并\n            videoData.push(audioData.raw.slice(8));\n            callWrite(videoData.raw);\n\n            // 释放存储空间\n            videoStream.boxs = videoStream.boxs.filter((item) => item !== videoMoof);\n            videoStream.boxs = videoStream.boxs.filter((item) => item !== videoData);\n            audioStream.boxs = audioStream.boxs.filter((item) => item !== audioMoof);\n            audioStream.boxs = audioStream.boxs.filter((item) => item !== audioData);\n\n            status += 1;\n            checkStream();\n          }\n        }\n      } else if (status > videoMaxIndex && status <= audioMaxIndex) {\n        // 追加 audio\n        const audioMoof = audioStream.boxs.find((item) => {\n          return (\n            item instanceof Boxes.moof && item?.mfhd.sequence_number === status\n          );\n        }) as Boxes.moof;\n        audioMoof.traf.tfhd.track_id = 2;\n        const audioData = audioMoof && (audioStream.boxs[audioStream.boxs.indexOf(audioMoof) + 1] as Boxes.mdat);\n        if (audioMoof && audioData) {\n          callWrite(audioMoof.raw);\n          callWrite(audioData.raw);\n          status += 1;\n          checkStream();\n        }\n      } else if (status > audioMaxIndex && status <= videoMaxIndex) {\n        // 追加 Video\n        const videoMoof = videoStream.boxs.find((item) => {\n          return (\n            item instanceof Boxes.moof && item?.mfhd.sequence_number === status\n          );\n        }) as Boxes.moof;\n        videoMoof.traf.tfhd.track_id = 1;\n        const videoData = videoMoof && (videoStream.boxs[videoStream.boxs.indexOf(videoMoof) + 1] as Boxes.mdat);\n        if (videoMoof && videoData) {\n          callWrite(videoMoof.raw);\n          callWrite(videoData.raw);\n          status += 1;\n          checkStream();\n        }\n      } else if (status > videoMaxIndex && status > audioMaxIndex) {\n        // end\n        status = -2;\n        // console.log(\"call close\", status, videoMaxIndex, audioMaxIndex);\n        // writer.releaseLock();\n        writer.close();\n      }\n    }\n  }\n\n  // 并行读取两个reader的数据\n  async function readerHandler(streamReader: ReadableStreamDefaultReader<any>, mp4Stream: Mp4Stream) {\n    while (true) {\n      const { done, value } = await streamReader.read();\n      if (value) {\n        mp4Stream.push(value);\n        mp4Stream.parse();\n\n        checkStream();\n      }\n      // 将value拼接到 chunk后\n\n      if (done) {\n        mp4Stream.end();\n        checkStream();\n        break;\n      }\n    }\n  }\n\n  readerHandler(videoReader, videoStream);\n  readerHandler(audioReader, audioStream);\n  return readable;\n}\n"],"names":["StreamBasic","__publicField","val","size","pos","view","i","Mp4Box","buf","value","bufs","item","boxRaw","base","nbuf","boxPos","type","tBuf","BoxClass","Boxes","Boxes.free","trex","trun","tfdt","tfhd","traf","box","mfhd","udta","mdia","ftyp","free","moov","mvhd","mvex","trak","moof","sidx","offset","refrenceCount","resList","tmp_32","reference_type","referenced_size","subsegment_duration","starts_with_SAP","SAP_type","SAP_delta_time","mdat","newBuf","tkhd","edts","mfra","tfra","mfro","Mp4Stream","Boxes.sidx","Boxes.moov","sliceBuf","remux","vs","as","videoReader","audioReader","videoStream","audioStream","readable","writable","writer","status","callWrite","checkStream","videoMoov","audioMoov","videoMvex","audioMvex","videoTrex","audioTrex","videoTrak","audioTrak","videoMaxIndex","audioMaxIndex","videoMoof","Boxes.moof","audioMoof","videoData","audioData","videoTraf","audioTraf","audioTrafSize","videoMoofSize","videoDataSize","readerHandler","streamReader","mp4Stream","done"],"mappings":"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"}