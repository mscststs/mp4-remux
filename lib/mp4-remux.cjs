"use strict";var W=Object.defineProperty;var H=(n,t,e)=>t in n?W(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var w=(n,t,e)=>(H(n,typeof t!="symbol"?t+"":t,e),e);const M=Object.freeze(Object.defineProperty({__proto__:null,get edts(){return Q},get free(){return S},get ftyp(){return K},get mdat(){return N},get mdia(){return J},get mfhd(){return O},get moof(){return k},get moov(){return V},get mvex(){return T},get mvhd(){return R},get sidx(){return q},get tfdt(){return F},get tfhd(){return P},get tkhd(){return j},get traf(){return C},get trak(){return E},get trex(){return A},get trun(){return B},get udta(){return G}},Symbol.toStringTag,{value:"Module"}));class d{constructor(t){w(this,"stream",new Uint8Array);w(this,"dv",new DataView(new Uint8Array().buffer));w(this,"boxs",[]);w(this,"boxPos",0);this.stream=t,this.dv=new DataView(t.buffer)}set size(t){this.writeUint(4,t)}get size(){return this.readUint(4)}get type(){return this.readString(4,4)}get raw(){if(this.boxPos){let t=this.boxPos;const e=this.boxs.map(u=>{const _=u.raw;return t+=_.length,_});this.size=t;const r=this.stream.slice(0,this.boxPos),s=new Uint8Array(t);let a=0;for(const u of[r,...e])s.set(u,a),a+=u.length;return s}return this.stream}writeUint(t,e,r=0){const s=this.dv;switch(t){case 1:s.setUint8(r,e);break;case 2:s.setUint16(r,e);break;case 4:s.setUint32(r,e);break}}writeInt(t,e,r=0){const s=this.dv;switch(t){case 1:s.setInt8(r,e);break;case 2:s.setInt16(r,e);break;case 4:s.setInt32(r,e);break}}readInt(t=4,e=0){const r=this.dv;switch(t){case 1:return r.getInt8(e);case 2:return r.getInt16(e);case 4:return r.getInt32(e)}}readUint(t,e=0){const r=this.dv;switch(t){case 1:return r.getUint8(e);case 2:return r.getUint16(e);case 4:return r.getUint32(e)}}readString(t,e=0){let r="";for(let s=0;s<t;s++)r+=String.fromCharCode(this.readUint(1,e+s));return r}parse(t){this.boxPos=t;let e=t;for(;e<=this.stream.length-8;){const r=this.readUint(4,e),s=this.readString(4,4+e);if(r<=this.stream.length){const a=this.stream.slice(e,e+r),u=M[s]||S;this.boxs.push(new u(a))}e+=r}}}class A extends d{get version(){return this.readUint(1,8)}get track_id(){return this.readUint(4,12)}set track_id(t){this.writeUint(4,t,12)}}class B extends d{get sample_count(){return this.readUint(4,12)}get data_offset(){return this.readInt(4,16)}set data_offset(t){this.writeInt(4,t,16)}}class F extends d{}class P extends d{get version(){return this.readUint(1,8)}get track_id(){return this.readUint(4,12)}set track_id(t){this.writeUint(4,t,12)}}class C extends d{constructor(t){super(t),this.parse(8)}get tfhd(){return this.boxs.find(t=>t instanceof P)}get trun(){return this.boxs.find(t=>t instanceof B)}}class O extends d{get sequence_number(){return this.readUint(4,12)}}class G extends d{}class J extends d{}class K extends d{}class S extends d{}class V extends d{constructor(t){super(t),this.parse(8)}get mvhd(){return this.boxs.find(t=>t instanceof R)}get mvex(){return this.boxs.find(t=>t instanceof T)}get trak(){return this.boxs.find(t=>t instanceof E)}}class k extends d{constructor(t){super(t),this.parse(8)}get mfhd(){return this.boxs.find(t=>t instanceof O)}get traf(){return this.boxs.find(t=>t instanceof C)}}class q extends d{get version(){return this.readUint(1,8)}get reference_ID(){return this.readUint(4,12)}get timescale(){return this.readUint(4,16)}get reserved(){let t=28;return this.version!==0&&(t=16+20),this.readUint(2,t)}get reference_count(){let t=28;return this.version!==0&&(t=16+20),t+=2,this.readUint(2,t)}get refList(){let t=32;this.version!==0&&(t=16+24);const e=this.reference_count,r=[];for(let s=0;s<e;s++){const a=t+s*12;let u=this.readUint(4,a);const _=u>>31&1,p=u&2147483647,c=this.readUint(4,a+4);u=this.readUint(4,a+8);const b=u>>31&1,v=u>>28&7,y=u&268435455;r.push({reference_type:_,referenced_size:p,subsegment_duration:c,starts_with_SAP:b,SAP_type:v,SAP_delta_time:y})}return r}}class N extends d{push(t){const e=new Uint8Array(this.stream.length+t.length);e.set(this.stream),e.set(t,this.stream.length),this.stream=e,this.dv=new DataView(this.stream.buffer),this.size=e.length}}class R extends d{get version(){return this.readUint(1,8)}get next_track_ID(){return this.version===0?this.readUint(4,104):this.readUint(4,116)}set next_track_ID(t){this.version===0?this.writeUint(4,t,104):this.writeUint(4,t,116)}}class T extends d{constructor(t){super(t),this.parse(8)}get trex(){return this.boxs.find(t=>t instanceof A)}}class j extends d{get version(){return this.readUint(1,8)}get track_id(){return this.version===1?this.readUint(4,28):this.readUint(4,20)}set track_id(t){this.version===1?this.writeUint(4,t,28):this.writeUint(4,t,20)}}class E extends d{constructor(t){super(t),this.parse(8)}get tkhd(){return this.boxs.find(t=>t instanceof j)}}class Q extends d{}class D{constructor(){w(this,"stream",new Uint8Array);w(this,"dv",new DataView(new Uint8Array().buffer));w(this,"boxs",[]);w(this,"isEnd",!1)}get sidx(){return this.boxs.find(t=>t instanceof q)}get moov(){return this.boxs.find(t=>t instanceof V)}push(t){const e=new Uint8Array(this.stream.length+t.length);e.set(this.stream),e.set(t,this.stream.length),this.stream=e,this.dv=new DataView(this.stream.buffer)}slice(t){const e=this.stream.slice(0,t),r=new Uint8Array(this.stream.length-t);return r.set(this.stream.slice(t)),this.stream=r,this.dv=new DataView(this.stream.buffer),e}readUint(t,e=0){const r=this.dv;switch(t){case 1:return r.getUint8(e);case 2:return r.getUint16(e);case 4:return r.getUint32(e)}}readString(t,e=0){let r="";for(let s=0;s<t;s++)r+=String.fromCharCode(this.readUint(1,e+s));return r}parse(){if(this.stream.length<8)return;const t=this.readUint(4),e=this.readString(4,4);if(t<=this.stream.length){const r=this.slice(t),s=M[e]||S;this.boxs.push(new s(r)),this.parse()}}end(){this.isEnd=!0}}function X(n,t){const e=n.getReader(),r=t.getReader(),s=new D,a=new D,{readable:u,writable:_}=new TransformStream,p=_.getWriter();let c=-1;function b(x){p.write(x)}async function v(){if(c===-1){const x=s.moov,g=a.moov;if(x&&g){const i=x.mvex,f=g.mvex;if(i&&f){const o=i.trex,l=f.trex;o.track_id=1,l.track_id=2,i.boxs=[],o&&i.boxs.push(o),l&&i.boxs.push(l)}const h=x.trak,U=g.trak;if(h&&U){h.tkhd.track_id=1,U.tkhd.track_id=2,x.boxs.push(U);for(const o of s.boxs)if(b(o.raw),o===x)break;c=1}}}if(!(!s.sidx||!a.sidx)&&c!==-1){const x=s.sidx.reference_count,g=a.sidx.reference_count;if(c<=x&&c<=g){const i=s.boxs.find(o=>o instanceof k&&(o==null?void 0:o.mfhd.sequence_number)===c),f=a.boxs.find(o=>o instanceof k&&(o==null?void 0:o.mfhd.sequence_number)===c),h=i&&s.boxs[s.boxs.indexOf(i)+1],U=f&&a.boxs[a.boxs.indexOf(f)+1];if(i&&h&&f&&U){const o=i.traf,l=f.traf;if(o.tfhd.track_id=1,l.tfhd.track_id=2,o!=null&&o.trun&&(l!=null&&l.trun)){const z=l.size,I=i.size,L=h.size;o.trun.data_offset=I+z+8,l.trun.data_offset=I+z+L,i.boxs.push(l),b(i.raw),h.push(U.raw.slice(8)),b(h.raw),s.boxs=s.boxs.filter(m=>m!==i),s.boxs=s.boxs.filter(m=>m!==h),a.boxs=a.boxs.filter(m=>m!==f),a.boxs=a.boxs.filter(m=>m!==U),c+=1,v()}}}else if(c>x&&c<=g){const i=a.boxs.find(h=>h instanceof k&&(h==null?void 0:h.mfhd.sequence_number)===c);i.traf.tfhd.track_id=2;const f=i&&a.boxs[a.boxs.indexOf(i)+1];i&&f&&(b(i.raw),b(f.raw),c+=1,v())}else if(c>g&&c<=x){const i=s.boxs.find(h=>h instanceof k&&(h==null?void 0:h.mfhd.sequence_number)===c);i.traf.tfhd.track_id=1;const f=i&&s.boxs[s.boxs.indexOf(i)+1];i&&f&&(b(i.raw),b(f.raw),c+=1,v())}else c>x&&c>g&&(c=-2,p.close())}}async function y(x,g){for(;;){const{done:i,value:f}=await x.read();if(f&&(g.push(f),g.parse(),v()),i){g.end(),v();break}}}return y(e,s),y(r,a),u}module.exports=X;
//# sourceMappingURL=mp4-remux.cjs.map
