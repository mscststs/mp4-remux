"use strict";var H=Object.defineProperty;var F=(n,t,e)=>t in n?H(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var k=(n,t,e)=>(F(n,typeof t!="symbol"?t+"":t,e),e);const D=Object.freeze(Object.defineProperty({__proto__:null,get edts(){return X},get free(){return y},get ftyp(){return N},get mdat(){return Q},get mdia(){return K},get mfhd(){return C},get mfra(){return Y},get mfro(){return $},get moof(){return p},get moov(){return R},get mvex(){return E},get mvhd(){return j},get sidx(){return T},get tfdt(){return G},get tfhd(){return O},get tfra(){return Z},get tkhd(){return L},get traf(){return q},get trak(){return V},get trex(){return A},get trun(){return P},get udta(){return J}},Symbol.toStringTag,{value:"Module"}));class B{constructor(){k(this,"_stream",new Uint8Array);k(this,"dv",new DataView(new Uint8Array().buffer))}get stream(){return this._stream}set stream(t){this._stream=t,this.dv=new DataView(t.buffer)}writeUint(t,e,s=0){const r=this.dv;switch(t){case 1:r.setUint8(s,e);break;case 2:r.setUint16(s,e);break;case 3:r.setUint16(s,e>>8),r.setUint8(s+2,e&255);return;case 4:r.setUint32(s,e);break}}writeInt(t,e,s=0){const r=this.dv;switch(t){case 1:r.setInt8(s,e);break;case 2:r.setInt16(s,e);break;case 4:r.setInt32(s,e);break}}readInt(t=4,e=0){const s=this.dv;switch(t){case 1:return s.getInt8(e);case 2:return s.getInt16(e);case 4:return s.getInt32(e)}}readUint(t,e=0){const s=this.dv;switch(t){case 1:return s.getUint8(e);case 2:return s.getUint16(e);case 3:return s.getUint16(e)<<8+s.getUint8(e+2);case 4:return s.getUint32(e)}}readString(t,e=0){let s="";for(let r=0;r<t;r++)s+=String.fromCharCode(this.readUint(1,e+r));return s}}class c extends B{constructor(e){super();k(this,"boxs",[]);k(this,"boxPos",0);this.stream=e}set size(e){this.writeUint(4,e)}get size(){return this.readUint(4)}get type(){return this.readString(4,4)}get raw(){if(this.boxPos){let e=this.boxPos;const s=this.boxs.map(b=>{const m=b.raw;return e+=m.length,m});this.size=e;const r=this.stream.slice(0,this.boxPos),a=new Uint8Array(e);let x=0;for(const b of[r,...s])a.set(b,x),x+=b.length;return a}return this.stream}parse(e){this.boxPos=e;let s=e;for(;s<=this.stream.length-8;){const r=this.readUint(4,s),a=this.readString(4,4+s);if(r<=this.stream.length){const x=this.stream.slice(s,s+r),b=D[a]||y;this.boxs.push(new b(x))}s+=r}}}class A extends c{get version(){return this.readUint(1,8)}get track_id(){return this.readUint(4,12)}set track_id(t){this.writeUint(4,t,12)}}class P extends c{get sample_count(){return this.readUint(4,12)}get data_offset(){return this.readInt(4,16)}set data_offset(t){this.writeInt(4,t,16)}}class G extends c{}class O extends c{get version(){return this.readUint(1,8)}get track_id(){return this.readUint(4,12)}set track_id(t){this.writeUint(4,t,12)}}class q extends c{constructor(t){super(t),this.parse(8)}get tfhd(){return this.boxs.find(t=>t instanceof O)}get trun(){return this.boxs.find(t=>t instanceof P)}}class C extends c{get sequence_number(){return this.readUint(4,12)}}class J extends c{}class K extends c{}class N extends c{}class y extends c{}class R extends c{constructor(t){super(t),this.parse(8)}get mvhd(){return this.boxs.find(t=>t instanceof j)}get mvex(){return this.boxs.find(t=>t instanceof E)}get trak(){return this.boxs.find(t=>t instanceof V)}}class p extends c{constructor(t){super(t),this.parse(8)}get mfhd(){return this.boxs.find(t=>t instanceof C)}get traf(){return this.boxs.find(t=>t instanceof q)}}class T extends c{get version(){return this.readUint(1,8)}get reference_ID(){return this.readUint(4,12)}get timescale(){return this.readUint(4,16)}get reserved(){let t=28;return this.version!==0&&(t=16+20),this.readUint(2,t)}get reference_count(){let t=28;return this.version!==0&&(t=16+20),t+=2,this.readUint(2,t)}get refList(){let t=32;this.version!==0&&(t=16+24);const e=this.reference_count,s=[];for(let r=0;r<e;r++){const a=t+r*12;let x=this.readUint(4,a);const b=x>>31&1,m=x&2147483647,d=this.readUint(4,a+4);x=this.readUint(4,a+8);const _=x>>31&1,U=x>>28&7,z=x&268435455;s.push({reference_type:b,referenced_size:m,subsegment_duration:d,starts_with_SAP:_,SAP_type:U,SAP_delta_time:z})}return s}}class Q extends c{push(t){const e=new Uint8Array(this.stream.length+t.length);e.set(this.stream),e.set(t,this.stream.length),this.stream=e,this.size=e.length}}class j extends c{get version(){return this.readUint(1,8)}get next_track_ID(){return this.version===0?this.readUint(4,104):this.readUint(4,116)}set next_track_ID(t){this.version===0?this.writeUint(4,t,104):this.writeUint(4,t,116)}}class E extends c{constructor(t){super(t),this.parse(8)}get trex(){return this.boxs.find(t=>t instanceof A)}}class L extends c{get version(){return this.readUint(1,8)}get track_id(){return this.version===1?this.readUint(4,28):this.readUint(4,20)}set track_id(t){this.version===1?this.writeUint(4,t,28):this.writeUint(4,t,20)}}class V extends c{constructor(t){super(t),this.parse(8)}get tkhd(){return this.boxs.find(t=>t instanceof L)}}class X extends c{}class Y extends c{constructor(t){super(t),this.parse(8)}}class Z extends c{get track_ID(){return this.readUint(4,12)}set track_ID(t){this.writeUint(4,t,12)}get length_size_of_sample_num(){return this.readUint(4,16)&3}get length_size_of_trun_num(){return this.readUint(4,16)>>2&3}get length_size_of_traf_num(){return this.readUint(4,16)>>4&3}get number_of_entry(){return this.readUint(4,20)}set number_of_entry(t){this.writeUint(4,t,20)}}class $ extends c{get _size(){return this.readUint(4,12)}set _size(t){this.writeUint(4,t,12)}}class M extends B{constructor(){super(...arguments);k(this,"boxs",[]);k(this,"isEnd",!1)}get sidx(){return this.boxs.find(e=>e instanceof T)}get moov(){return this.boxs.find(e=>e instanceof R)}push(e){const s=new Uint8Array(this.stream.length+e.length);s.set(this.stream),s.set(e,this.stream.length),this.stream=s}slice(e){const s=this.stream.slice(0,e),r=new Uint8Array(this.stream.length-e);return r.set(this.stream.slice(e)),this.stream=r,s}parse(){if(this.stream.length<8)return;const e=this.readUint(4),s=this.readString(4,4);if(e<=this.stream.length){const r=this.slice(e),a=D[s]||y;this.boxs.push(new a(r)),this.parse()}}end(){this.isEnd=!0}}function tt(n,t){const e=n.getReader(),s=t.getReader(),r=new M,a=new M,{readable:x,writable:b}=new TransformStream,m=b.getWriter();let d=-1;function _(f){m.write(f)}async function U(){if(d===-1){const f=r.moov,g=a.moov;if(f&&g){const i=f.mvex,h=g.mvex;if(i&&h){const o=i.trex,l=h.trex;o.track_id=1,l.track_id=2,i.boxs=[],o&&i.boxs.push(o),l&&i.boxs.push(l)}const u=f.trak,w=g.trak;if(u&&w){u.tkhd.track_id=1,w.tkhd.track_id=2,f.boxs.push(w);for(const o of r.boxs)if(_(o.raw),o===f)break;d=1}}}if(!(!r.sidx||!a.sidx)&&d!==-1){const f=r.sidx.reference_count,g=a.sidx.reference_count;if(d<=f&&d<=g){const i=r.boxs.find(o=>o instanceof p&&(o==null?void 0:o.mfhd.sequence_number)===d),h=a.boxs.find(o=>o instanceof p&&(o==null?void 0:o.mfhd.sequence_number)===d),u=i&&r.boxs[r.boxs.indexOf(i)+1],w=h&&a.boxs[a.boxs.indexOf(h)+1];if(i&&u&&h&&w){const o=i.traf,l=h.traf;if(o.tfhd.track_id=1,l.tfhd.track_id=2,o!=null&&o.trun&&(l!=null&&l.trun)){const I=l.size,S=i.size,W=u.size;o.trun.data_offset=S+I+8,l.trun.data_offset=S+I+W,i.boxs.push(l),_(i.raw),u.push(w.raw.slice(8)),_(u.raw),r.boxs=r.boxs.filter(v=>v!==i),r.boxs=r.boxs.filter(v=>v!==u),a.boxs=a.boxs.filter(v=>v!==h),a.boxs=a.boxs.filter(v=>v!==w),d+=1,U()}}}else if(d>f&&d<=g){const i=a.boxs.find(u=>u instanceof p&&(u==null?void 0:u.mfhd.sequence_number)===d);i.traf.tfhd.track_id=2;const h=i&&a.boxs[a.boxs.indexOf(i)+1];i&&h&&(_(i.raw),_(h.raw),d+=1,U())}else if(d>g&&d<=f){const i=r.boxs.find(u=>u instanceof p&&(u==null?void 0:u.mfhd.sequence_number)===d);i.traf.tfhd.track_id=1;const h=i&&r.boxs[r.boxs.indexOf(i)+1];i&&h&&(_(i.raw),_(h.raw),d+=1,U())}else d>f&&d>g&&(d=-2,m.close())}}async function z(f,g){for(;;){const{done:i,value:h}=await f.read();if(h&&(g.push(h),g.parse(),U()),i){g.end(),U();break}}}return z(e,r),z(s,a),x}module.exports=tt;
//# sourceMappingURL=mp4-remux.cjs.map
