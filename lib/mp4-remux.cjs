"use strict";var q=Object.defineProperty;var T=(r,t,e)=>t in r?q(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var w=(r,t,e)=>(T(r,typeof t!="symbol"?t+"":t,e),e);const C=Object.freeze(Object.defineProperty({__proto__:null,get edts(){return Q},get free(){return D},get ftyp(){return H},get mdat(){return J},get mdia(){return W},get mfhd(){return z},get moof(){return k},get moov(){return F},get mvex(){return A},get mvhd(){return K},get sidx(){return G},get tfdt(){return j},get tfhd(){return E},get tkhd(){return N},get traf(){return M},get trak(){return O},get trex(){return I},get trun(){return V},get udta(){return L}},Symbol.toStringTag,{value:"Module"}));class o{constructor(t){w(this,"stream",new Uint8Array);w(this,"dv",new DataView(new Uint8Array().buffer));w(this,"boxs",[]);w(this,"boxPos",0);this.stream=t,this.dv=new DataView(t.buffer)}set size(t){this.writeUint(4,t)}get size(){return this.readUint(4)}get type(){return this.readString(4,4)}get raw(){if(this.boxPos){let t=this.boxPos;const e=this.boxs.map(u=>{const U=u.raw;return t+=U.length,U});this.size=t;const s=this.stream.slice(0,this.boxPos),n=new Uint8Array(t);let i=0;for(const u of[s,...e])n.set(u,i),i+=u.length;return n}return this.stream}writeUint(t,e,s=0){const n=this.dv;switch(t){case 1:n.setUint8(s,e);break;case 2:n.setUint16(s,e);break;case 4:n.setUint32(s,e);break}}writeInt(t,e,s=0){const n=this.dv;switch(t){case 1:n.setInt8(s,e);break;case 2:n.setInt16(s,e);break;case 4:n.setInt32(s,e);break}}readInt(t=4,e=0){const s=this.dv;switch(t){case 1:return s.getInt8(e);case 2:return s.getInt16(e);case 4:return s.getInt32(e)}}readUint(t,e=0){const s=this.dv;switch(t){case 1:return s.getUint8(e);case 2:return s.getUint16(e);case 4:return s.getUint32(e)}}readString(t,e=0){let s="";for(let n=0;n<t;n++)s+=String.fromCharCode(this.readUint(1,e+n));return s}parse(t){this.boxPos=t;let e=t;for(;e<=this.stream.length-8;){const s=this.readUint(4,e),n=this.readString(4,4+e);if(s<=this.stream.length){const i=this.stream.slice(e,e+s),u=C[n]||D;this.boxs.push(new u(i))}e+=s}}}class I extends o{}class V extends o{get sample_count(){return this.readUint(4,12)}get data_offset(){return this.readInt(4,16)}set data_offset(t){this.writeInt(4,t,16)}}class j extends o{}class E extends o{}class M extends o{constructor(t){super(t),this.parse(8)}get trun(){return this.boxs.find(t=>t instanceof V)}}class z extends o{get sequence_number(){return this.readUint(4,12)}}class L extends o{}class W extends o{}class H extends o{}class D extends o{}class F extends o{constructor(t){super(t),this.parse(8)}}class k extends o{constructor(t){super(t),this.parse(8)}}class G extends o{get version(){return this.readUint(1,8)}get reference_ID(){return this.readUint(4,12)}get timescale(){return this.readUint(4,16)}get reserved(){let t=28;return this.version!==0&&(t=16+20),this.readUint(2,t)}get reference_count(){let t=28;return this.version!==0&&(t=16+20),t+=2,this.readUint(2,t)}get refList(){let t=32;this.version!==0&&(t=16+24);const e=this.reference_count,s=[];for(let n=0;n<e;n++){const i=t+n*12;let u=this.readUint(4,i);const U=u>>31&1,y=u&2147483647,c=this.readUint(4,i+4);u=this.readUint(4,i+8);const m=u>>31&1,p=u>>28&7,S=u&268435455;s.push({reference_type:U,referenced_size:y,subsegment_duration:c,starts_with_SAP:m,SAP_type:p,SAP_delta_time:S})}return s}}class J extends o{push(t){const e=new Uint8Array(this.stream.length+t.length);e.set(this.stream),e.set(t,this.stream.length),this.stream=e,this.dv=new DataView(this.stream.buffer),this.size=e.length}}class K extends o{}class A extends o{constructor(t){super(t),this.parse(8)}}class O extends o{}class N extends o{}class Q extends o{}class P{constructor(){w(this,"stream",new Uint8Array);w(this,"dv",new DataView(new Uint8Array().buffer));w(this,"boxs",[]);w(this,"isEnd",!1)}get sidx(){return this.boxs.find(t=>t.type==="sidx")}get moov(){return this.boxs.find(t=>t.type==="moov")}push(t){const e=new Uint8Array(this.stream.length+t.length);e.set(this.stream),e.set(t,this.stream.length),this.stream=e,this.dv=new DataView(this.stream.buffer)}slice(t){const e=this.stream.slice(0,t),s=new Uint8Array(this.stream.length-t);return s.set(this.stream.slice(t)),this.stream=s,this.dv=new DataView(this.stream.buffer),e}readUint(t,e=0){const s=this.dv;switch(t){case 1:return s.getUint8(e);case 2:return s.getUint16(e);case 4:return s.getUint32(e)}}readString(t,e=0){let s="";for(let n=0;n<t;n++)s+=String.fromCharCode(this.readUint(1,e+n));return s}parse(){if(this.stream.length<8)return;const t=this.readUint(4),e=this.readString(4,4);if(t<=this.stream.length){const s=this.slice(t),n=C[e]||D;this.boxs.push(new n(s)),this.parse()}}end(){this.isEnd=!0}}function X(r,t){const e=r.getReader(),s=t.getReader(),n=new P,i=new P,{readable:u,writable:U}=new TransformStream,y=U.getWriter();let c=-1;function m(x){y.write(x)}async function p(){if(c===-1){const x=n.moov,b=i.moov;if(x&&b){const a=b.boxs.find(f=>f instanceof O),d=x.boxs.find(f=>f instanceof A),l=b.boxs.find(f=>f instanceof A);if(d&&l){const f=d.boxs.find(g=>g instanceof I),h=l.boxs.find(g=>g instanceof I);d.boxs=[],f&&d.boxs.push(f),h&&d.boxs.push(h)}if(a){x.boxs.push(a);for(const f of n.boxs)if(m(f.raw),f===x)break;c=1}}}if(!(!n.sidx||!i.sidx)&&c!==-1){const x=n.sidx.reference_count,b=i.sidx.reference_count;if(c<=x&&c<=b){const a=n.boxs.find(h=>h instanceof k&&h.boxs[0]instanceof z&&h.boxs[0].sequence_number===c),d=i.boxs.find(h=>h instanceof k&&h.boxs[0]instanceof z&&h.boxs[0].sequence_number===c),l=a&&n.boxs[n.boxs.indexOf(a)+1],f=d&&i.boxs[i.boxs.indexOf(d)+1];if(a&&l&&d&&f){const h=a.boxs.find(_=>_ instanceof M),g=d.boxs.find(_=>_ instanceof M);if(h!=null&&h.trun&&(g!=null&&g.trun)){const _=g.size,B=a.size,R=l.size;h.trun.data_offset=B+_+8,g.trun.data_offset=B+_+R,a.boxs.push(g),m(a.raw),l.push(f.raw.slice(8)),m(l.raw),n.boxs=n.boxs.filter(v=>v!==a),n.boxs=n.boxs.filter(v=>v!==l),i.boxs=i.boxs.filter(v=>v!==d),i.boxs=i.boxs.filter(v=>v!==f),c+=1,p()}}}else if(c>x&&c<=b){const a=i.boxs.find(l=>l instanceof k&&l.boxs[0]instanceof z&&l.boxs[0].sequence_number===c),d=a&&i.boxs[i.boxs.indexOf(a)+1];a&&d&&(m(a.raw),m(d.raw),c+=1,p())}else c>x&&c>b&&(c=-2,y.close())}}async function S(x,b){for(;;){const{done:a,value:d}=await x.read();if(d&&(b.push(d),b.parse(),p()),a){b.end(),p();break}}}return S(e,n),S(s,i),u}module.exports=X;
//# sourceMappingURL=mp4-remux.cjs.map
