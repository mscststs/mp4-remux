(function(x,r){typeof exports=="object"&&typeof module<"u"?module.exports=r():typeof define=="function"&&define.amd?define(r):(x=typeof globalThis<"u"?globalThis:x||self,x.mp4Remux=r())})(this,function(){"use strict";var Q=Object.defineProperty;var X=(x,r,w)=>r in x?Q(x,r,{enumerable:!0,configurable:!0,writable:!0,value:w}):x[r]=w;var v=(x,r,w)=>(X(x,typeof r!="symbol"?r+"":r,w),w);const x=Object.freeze(Object.defineProperty({__proto__:null,get edts(){return J},get free(){return D},get ftyp(){return E},get mdat(){return H},get mdia(){return j},get mfhd(){return z},get moof(){return k},get moov(){return L},get mvex(){return B},get mvhd(){return F},get sidx(){return W},get tfdt(){return V},get tfhd(){return O},get tkhd(){return G},get traf(){return A},get trak(){return C},get trex(){return w},get trun(){return P},get udta(){return q}},Symbol.toStringTag,{value:"Module"}));class r{constructor(e){v(this,"stream",new Uint8Array);v(this,"dv",new DataView(new Uint8Array().buffer));v(this,"boxs",[]);v(this,"boxPos",0);this.stream=e,this.dv=new DataView(e.buffer)}set size(e){this.writeUint(4,e)}get size(){return this.readUint(4)}get type(){return this.readString(4,4)}get raw(){if(this.boxPos){let e=this.boxPos;const t=this.boxs.map(f=>{const _=f.raw;return e+=_.length,_});this.size=e;const s=this.stream.slice(0,this.boxPos),n=new Uint8Array(e);let i=0;for(const f of[s,...t])n.set(f,i),i+=f.length;return n}return this.stream}writeUint(e,t,s=0){const n=this.dv;switch(e){case 1:n.setUint8(s,t);break;case 2:n.setUint16(s,t);break;case 4:n.setUint32(s,t);break}}writeInt(e,t,s=0){const n=this.dv;switch(e){case 1:n.setInt8(s,t);break;case 2:n.setInt16(s,t);break;case 4:n.setInt32(s,t);break}}readInt(e=4,t=0){const s=this.dv;switch(e){case 1:return s.getInt8(t);case 2:return s.getInt16(t);case 4:return s.getInt32(t)}}readUint(e,t=0){const s=this.dv;switch(e){case 1:return s.getUint8(t);case 2:return s.getUint16(t);case 4:return s.getUint32(t)}}readString(e,t=0){let s="";for(let n=0;n<e;n++)s+=String.fromCharCode(this.readUint(1,t+n));return s}parse(e){this.boxPos=e;let t=e;for(;t<=this.stream.length-8;){const s=this.readUint(4,t),n=this.readString(4,4+t);if(s<=this.stream.length){const i=this.stream.slice(t,t+s),f=x[n]||D;this.boxs.push(new f(i))}t+=s}}}class w extends r{}class P extends r{get sample_count(){return this.readUint(4,12)}get data_offset(){return this.readInt(4,16)}set data_offset(e){this.writeInt(4,e,16)}}class V extends r{}class O extends r{}class A extends r{constructor(e){super(e),this.parse(8)}get trun(){return this.boxs.find(e=>e instanceof P)}}class z extends r{get sequence_number(){return this.readUint(4,12)}}class q extends r{}class j extends r{}class E extends r{}class D extends r{}class L extends r{constructor(e){super(e),this.parse(8)}}class k extends r{constructor(e){super(e),this.parse(8)}}class W extends r{get version(){return this.readUint(1,8)}get reference_ID(){return this.readUint(4,12)}get timescale(){return this.readUint(4,16)}get reserved(){let e=28;return this.version!==0&&(e=16+20),this.readUint(2,e)}get reference_count(){let e=28;return this.version!==0&&(e=16+20),e+=2,this.readUint(2,e)}get refList(){let e=32;this.version!==0&&(e=16+24);const t=this.reference_count,s=[];for(let n=0;n<t;n++){const i=e+n*12;let f=this.readUint(4,i);const _=f>>31&1,I=f&2147483647,c=this.readUint(4,i+4);f=this.readUint(4,i+8);const U=f>>31&1,y=f>>28&7,M=f&268435455;s.push({reference_type:_,referenced_size:I,subsegment_duration:c,starts_with_SAP:U,SAP_type:y,SAP_delta_time:M})}return s}}class H extends r{push(e){const t=new Uint8Array(this.stream.length+e.length);t.set(this.stream),t.set(e,this.stream.length),this.stream=t,this.dv=new DataView(this.stream.buffer),this.size=t.length}}class F extends r{}class B extends r{constructor(e){super(e),this.parse(8)}}class C extends r{}class G extends r{}class J extends r{}class R{constructor(){v(this,"stream",new Uint8Array);v(this,"dv",new DataView(new Uint8Array().buffer));v(this,"boxs",[]);v(this,"isEnd",!1)}get sidx(){return this.boxs.find(e=>e.type==="sidx")}get moov(){return this.boxs.find(e=>e.type==="moov")}push(e){const t=new Uint8Array(this.stream.length+e.length);t.set(this.stream),t.set(e,this.stream.length),this.stream=t,this.dv=new DataView(this.stream.buffer)}slice(e){const t=this.stream.slice(0,e),s=new Uint8Array(this.stream.length-e);return s.set(this.stream.slice(e)),this.stream=s,this.dv=new DataView(this.stream.buffer),t}readUint(e,t=0){const s=this.dv;switch(e){case 1:return s.getUint8(t);case 2:return s.getUint16(t);case 4:return s.getUint32(t)}}readString(e,t=0){let s="";for(let n=0;n<e;n++)s+=String.fromCharCode(this.readUint(1,t+n));return s}parse(){if(this.stream.length<8)return;const e=this.readUint(4),t=this.readString(4,4);if(e<=this.stream.length){const s=this.slice(e),n=x[t]||D;this.boxs.push(new n(s)),this.parse()}}end(){this.isEnd=!0}}function K(o,e){const t=o.getReader(),s=e.getReader(),n=new R,i=new R,{readable:f,writable:_}=new TransformStream,I=_.getWriter();let c=-1;function U(l){I.write(l)}async function y(){if(c===-1){const l=n.moov,g=i.moov;if(l&&g){const a=g.boxs.find(u=>u instanceof C),d=l.boxs.find(u=>u instanceof B),b=g.boxs.find(u=>u instanceof B);if(d&&b){const u=d.boxs.find(m=>m instanceof w),h=b.boxs.find(m=>m instanceof w);d.boxs=[],u&&d.boxs.push(u),h&&d.boxs.push(h)}if(a){l.boxs.push(a);for(const u of n.boxs)if(U(u.raw),u===l)break;c=1}}}if(!(!n.sidx||!i.sidx)&&c!==-1){const l=n.sidx.reference_count,g=i.sidx.reference_count;if(c<=l&&c<=g){const a=n.boxs.find(h=>h instanceof k&&h.boxs[0]instanceof z&&h.boxs[0].sequence_number===c),d=i.boxs.find(h=>h instanceof k&&h.boxs[0]instanceof z&&h.boxs[0].sequence_number===c),b=a&&n.boxs[n.boxs.indexOf(a)+1],u=d&&i.boxs[i.boxs.indexOf(d)+1];if(a&&b&&d&&u){const h=a.boxs.find(S=>S instanceof A),m=d.boxs.find(S=>S instanceof A);if(h!=null&&h.trun&&(m!=null&&m.trun)){const S=m.size,T=a.size,N=b.size;h.trun.data_offset=T+S+8,m.trun.data_offset=T+S+N,a.boxs.push(m),U(a.raw),b.push(u.raw.slice(8)),U(b.raw),n.boxs=n.boxs.filter(p=>p!==a),n.boxs=n.boxs.filter(p=>p!==b),i.boxs=i.boxs.filter(p=>p!==d),i.boxs=i.boxs.filter(p=>p!==u),c+=1,y()}}}else if(c>l&&c<=g){const a=i.boxs.find(b=>b instanceof k&&b.boxs[0]instanceof z&&b.boxs[0].sequence_number===c),d=a&&i.boxs[i.boxs.indexOf(a)+1];a&&d&&(U(a.raw),U(d.raw),c+=1,y())}else c>l&&c>g&&(c=-2,I.close())}}async function M(l,g){for(;;){const{done:a,value:d}=await l.read();if(d&&(g.push(d),g.parse(),y()),a){g.end(),y();break}}}return M(t,n),M(s,i),f}return K});
//# sourceMappingURL=mp4-remux.umd.cjs.map
