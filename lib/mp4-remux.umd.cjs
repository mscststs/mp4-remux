(function(g,n){typeof exports=="object"&&typeof module<"u"?module.exports=n():typeof define=="function"&&define.amd?define(n):(g=typeof globalThis<"u"?globalThis:g||self,g.mp4Remux=n())})(this,function(){"use strict";var Q=Object.defineProperty;var X=(g,n,v)=>n in g?Q(g,n,{enumerable:!0,configurable:!0,writable:!0,value:v}):g[n]=v;var m=(g,n,v)=>(X(g,typeof n!="symbol"?n+"":n,v),v);const g=Object.freeze(Object.defineProperty({__proto__:null,get edts(){return J},get free(){return I},get ftyp(){return F},get mdat(){return G},get mdia(){return H},get mfhd(){return B},get moof(){return y},get moov(){return P},get mvex(){return O},get mvhd(){return T},get sidx(){return C},get tfdt(){return L},get tfhd(){return M},get tkhd(){return R},get traf(){return A},get trak(){return V},get trex(){return v},get trun(){return D},get udta(){return W}},Symbol.toStringTag,{value:"Module"}));class n{constructor(t){m(this,"stream",new Uint8Array);m(this,"dv",new DataView(new Uint8Array().buffer));m(this,"boxs",[]);m(this,"boxPos",0);this.stream=t,this.dv=new DataView(t.buffer)}set size(t){this.writeUint(4,t)}get size(){return this.readUint(4)}get type(){return this.readString(4,4)}get raw(){if(this.boxPos){let t=this.boxPos;const e=this.boxs.map(u=>{const p=u.raw;return t+=p.length,p});this.size=t;const r=this.stream.slice(0,this.boxPos),s=new Uint8Array(t);let a=0;for(const u of[r,...e])s.set(u,a),a+=u.length;return s}return this.stream}writeUint(t,e,r=0){const s=this.dv;switch(t){case 1:s.setUint8(r,e);break;case 2:s.setUint16(r,e);break;case 4:s.setUint32(r,e);break}}writeInt(t,e,r=0){const s=this.dv;switch(t){case 1:s.setInt8(r,e);break;case 2:s.setInt16(r,e);break;case 4:s.setInt32(r,e);break}}readInt(t=4,e=0){const r=this.dv;switch(t){case 1:return r.getInt8(e);case 2:return r.getInt16(e);case 4:return r.getInt32(e)}}readUint(t,e=0){const r=this.dv;switch(t){case 1:return r.getUint8(e);case 2:return r.getUint16(e);case 4:return r.getUint32(e)}}readString(t,e=0){let r="";for(let s=0;s<t;s++)r+=String.fromCharCode(this.readUint(1,e+s));return r}parse(t){this.boxPos=t;let e=t;for(;e<=this.stream.length-8;){const r=this.readUint(4,e),s=this.readString(4,4+e);if(r<=this.stream.length){const a=this.stream.slice(e,e+r),u=g[s]||I;this.boxs.push(new u(a))}e+=r}}}class v extends n{get version(){return this.readUint(1,8)}get track_id(){return this.readUint(4,12)}set track_id(t){this.writeUint(4,t,12)}}class D extends n{get sample_count(){return this.readUint(4,12)}get data_offset(){return this.readInt(4,16)}set data_offset(t){this.writeInt(4,t,16)}}class L extends n{}class M extends n{get version(){return this.readUint(1,8)}get track_id(){return this.readUint(4,12)}set track_id(t){this.writeUint(4,t,12)}}class A extends n{constructor(t){super(t),this.parse(8)}get tfhd(){return this.boxs.find(t=>t instanceof M)}get trun(){return this.boxs.find(t=>t instanceof D)}}class B extends n{get sequence_number(){return this.readUint(4,12)}}class W extends n{}class H extends n{}class F extends n{}class I extends n{}class P extends n{constructor(t){super(t),this.parse(8)}get mvhd(){return this.boxs.find(t=>t instanceof T)}get mvex(){return this.boxs.find(t=>t instanceof O)}get trak(){return this.boxs.find(t=>t instanceof V)}}class y extends n{constructor(t){super(t),this.parse(8)}get mfhd(){return this.boxs.find(t=>t instanceof B)}get traf(){return this.boxs.find(t=>t instanceof A)}}class C extends n{get version(){return this.readUint(1,8)}get reference_ID(){return this.readUint(4,12)}get timescale(){return this.readUint(4,16)}get reserved(){let t=28;return this.version!==0&&(t=16+20),this.readUint(2,t)}get reference_count(){let t=28;return this.version!==0&&(t=16+20),t+=2,this.readUint(2,t)}get refList(){let t=32;this.version!==0&&(t=16+24);const e=this.reference_count,r=[];for(let s=0;s<e;s++){const a=t+s*12;let u=this.readUint(4,a);const p=u>>31&1,S=u&2147483647,c=this.readUint(4,a+4);u=this.readUint(4,a+8);const w=u>>31&1,U=u>>28&7,z=u&268435455;r.push({reference_type:p,referenced_size:S,subsegment_duration:c,starts_with_SAP:w,SAP_type:U,SAP_delta_time:z})}return r}}class G extends n{push(t){const e=new Uint8Array(this.stream.length+t.length);e.set(this.stream),e.set(t,this.stream.length),this.stream=e,this.dv=new DataView(this.stream.buffer),this.size=e.length}}class T extends n{get version(){return this.readUint(1,8)}get next_track_ID(){return this.version===0?this.readUint(4,104):this.readUint(4,116)}set next_track_ID(t){this.version===0?this.writeUint(4,t,104):this.writeUint(4,t,116)}}class O extends n{constructor(t){super(t),this.parse(8)}get trex(){return this.boxs.find(t=>t instanceof v)}}class R extends n{get version(){return this.readUint(1,8)}get track_id(){return this.version===1?this.readUint(4,28):this.readUint(4,20)}set track_id(t){this.version===1?this.writeUint(4,t,28):this.writeUint(4,t,20)}}class V extends n{constructor(t){super(t),this.parse(8)}get tkhd(){return this.boxs.find(t=>t instanceof R)}}class J extends n{}class q{constructor(){m(this,"stream",new Uint8Array);m(this,"dv",new DataView(new Uint8Array().buffer));m(this,"boxs",[]);m(this,"isEnd",!1)}get sidx(){return this.boxs.find(t=>t instanceof C)}get moov(){return this.boxs.find(t=>t instanceof P)}push(t){const e=new Uint8Array(this.stream.length+t.length);e.set(this.stream),e.set(t,this.stream.length),this.stream=e,this.dv=new DataView(this.stream.buffer)}slice(t){const e=this.stream.slice(0,t),r=new Uint8Array(this.stream.length-t);return r.set(this.stream.slice(t)),this.stream=r,this.dv=new DataView(this.stream.buffer),e}readUint(t,e=0){const r=this.dv;switch(t){case 1:return r.getUint8(e);case 2:return r.getUint16(e);case 4:return r.getUint32(e)}}readString(t,e=0){let r="";for(let s=0;s<t;s++)r+=String.fromCharCode(this.readUint(1,e+s));return r}parse(){if(this.stream.length<8)return;const t=this.readUint(4),e=this.readString(4,4);if(t<=this.stream.length){const r=this.slice(t),s=g[e]||I;this.boxs.push(new s(r)),this.parse()}}end(){this.isEnd=!0}}function K(o,t){const e=o.getReader(),r=t.getReader(),s=new q,a=new q,{readable:u,writable:p}=new TransformStream,S=p.getWriter();let c=-1;function w(x){S.write(x)}async function U(){if(c===-1){const x=s.moov,l=a.moov;if(x&&l){const i=x.mvex,h=l.mvex;if(i&&h){const d=i.trex,b=h.trex;d.track_id=1,b.track_id=2,i.boxs=[],d&&i.boxs.push(d),b&&i.boxs.push(b)}const f=x.trak,_=l.trak;if(f&&_){f.tkhd.track_id=1,_.tkhd.track_id=2,x.boxs.push(_);for(const d of s.boxs)if(w(d.raw),d===x)break;c=1}}}if(!(!s.sidx||!a.sidx)&&c!==-1){const x=s.sidx.reference_count,l=a.sidx.reference_count;if(c<=x&&c<=l){const i=s.boxs.find(d=>d instanceof y&&(d==null?void 0:d.mfhd.sequence_number)===c),h=a.boxs.find(d=>d instanceof y&&(d==null?void 0:d.mfhd.sequence_number)===c),f=i&&s.boxs[s.boxs.indexOf(i)+1],_=h&&a.boxs[a.boxs.indexOf(h)+1];if(i&&f&&h&&_){const d=i.traf,b=h.traf;if(d.tfhd.track_id=1,b.tfhd.track_id=2,d!=null&&d.trun&&(b!=null&&b.trun)){const j=b.size,E=i.size,N=f.size;d.trun.data_offset=E+j+8,b.trun.data_offset=E+j+N,i.boxs.push(b),w(i.raw),f.push(_.raw.slice(8)),w(f.raw),s.boxs=s.boxs.filter(k=>k!==i),s.boxs=s.boxs.filter(k=>k!==f),a.boxs=a.boxs.filter(k=>k!==h),a.boxs=a.boxs.filter(k=>k!==_),c+=1,U()}}}else if(c>x&&c<=l){const i=a.boxs.find(f=>f instanceof y&&(f==null?void 0:f.mfhd.sequence_number)===c);i.traf.tfhd.track_id=2;const h=i&&a.boxs[a.boxs.indexOf(i)+1];i&&h&&(w(i.raw),w(h.raw),c+=1,U())}else if(c>l&&c<=x){const i=s.boxs.find(f=>f instanceof y&&(f==null?void 0:f.mfhd.sequence_number)===c);i.traf.tfhd.track_id=1;const h=i&&s.boxs[s.boxs.indexOf(i)+1];i&&h&&(w(i.raw),w(h.raw),c+=1,U())}else c>x&&c>l&&(c=-2,S.close())}}async function z(x,l){for(;;){const{done:i,value:h}=await x.read();if(h&&(l.push(h),l.parse(),U()),i){l.end(),U();break}}}return z(e,s),z(r,a),u}return K});
//# sourceMappingURL=mp4-remux.umd.cjs.map
