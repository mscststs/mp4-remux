<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test</title>
  <script type="module">
    import remux from "./src/index.ts";
    import { Mp4Stream } from "./src/Mp4Stream.class";


    function getStream(file){
      const b = new Blob([file], { type: "video/mp4" });
      return b.stream();
    }
    // get Uint8Array
    function getBuffer(file){
      const b = new Blob([file], { type: "video/mp4" });
      return b.arrayBuffer();
    }

    window.handleMerge = async  function (){
      const videoStream = getStream(document.querySelector("#video").files[0]);
      const audioStream = getStream(document.querySelector("#audio").files[0]);


      const remuxedStream = remux(videoStream, audioStream);

      const fileHandler = await window?.showSaveFilePicker({
        suggestedName: "output.mp4",
        types: [
          { accept: {
              "video/mp4": ".mp4"
            }
          }],
      });

      const writable = await fileHandler.createWritable();

      const writableStream = new WritableStream({
        write: (chunk)=>writable.write(chunk),
        close: ()=>{
          alert("Write Success");
          writable.close()
        },
      })

      remuxedStream.pipeTo(writableStream);
    }


    window.handleDetect = async function (){
      const videoBuffer = await getBuffer(document.querySelector("#det").files[0]);
      const buf = new Uint8Array(videoBuffer)
      const mp4Stream = new Mp4Stream();
      mp4Stream.push(buf);
      mp4Stream.parse();
      console.log(mp4Stream)
    }

  </script>
</head>
<body>
  <div style="display:flex;flex-direction: column; padding:20px;">

    <label for="">视频<input type="file" id="video"></label>
    <label for="">音频<input type="file" id="audio"></label>
    <button onclick="handleMerge()"> 合并</button>
  </div>


  <div>

    <label for="">视频<input type="file" id="det"></label>
    <button onclick="handleDetect()">检测</button>
  </div>
</body>
</html>